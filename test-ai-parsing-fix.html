<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test AI Parsing Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            cursor: pointer; 
        }
    </style>
</head>
<body>
    <h1>AI Parsing Fix Test</h1>
    <p>Testing various AI response formats to ensure proper parsing.</p>
    
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="results"></div>

    <script>
        // Import the parseAIHint logic for testing
        function parseAIHint(aiResponse) {
            console.log('ğŸ” Parsing AI hint response type:', typeof aiResponse);
            console.log('ğŸ” Response length:', aiResponse ? aiResponse.length : 0);
            console.log('ğŸ” First 500 chars:', aiResponse ? aiResponse.substring(0, 500) : 'null/undefined');
            
            try {
                // Check if response is already an object
                if (typeof aiResponse === 'object' && aiResponse !== null) {
                    console.log('ğŸ“¦ Response is already an object:', aiResponse);
                    return validateHintObject(aiResponse);
                }
                
                // Handle string responses
                if (typeof aiResponse !== 'string') {
                    throw new Error(`Invalid response type: ${typeof aiResponse}`);
                }
                
                // Try to parse as direct JSON first
                let parsed;
                
                // Remove any markdown code blocks if present
                const cleanedResponse = aiResponse
                    .replace(/```json\s*/gi, '')
                    .replace(/```\s*/gi, '')
                    .trim();
                
                console.log('ğŸ§¹ Cleaned response preview:', cleanedResponse.substring(0, 200));
                
                try {
                    parsed = JSON.parse(cleanedResponse);
                } catch (e) {
                    console.log('ğŸ“Œ Direct JSON parse failed, trying to extract JSON...');
                    
                    // Try multiple JSON extraction patterns
                    const jsonPatterns = [
                        /\{[\s\S]*\}/,  // Standard JSON object
                        /\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/  // Nested JSON objects
                    ];
                    
                    let jsonMatch = null;
                    for (const pattern of jsonPatterns) {
                        jsonMatch = cleanedResponse.match(pattern);
                        if (jsonMatch) {
                            console.log('ğŸ¯ JSON pattern matched');
                            break;
                        }
                    }
                    
                    if (jsonMatch) {
                        try {
                            parsed = JSON.parse(jsonMatch[0]);
                        } catch (e2) {
                            console.error('âŒ JSON extraction failed:', e2);
                            throw new Error('Found JSON but could not parse it');
                        }
                    } else {
                        throw new Error('No valid JSON structure found in response');
                    }
                }
                
                console.log('âœ… Successfully parsed AI hint:', parsed);
                return validateHintObject(parsed);
                
            } catch (error) {
                console.error('âŒ AI hint parsing failed:', error.message);
                
                // Enhanced fallback
                return {
                    structure: 'ç„¡æ³•è§£æAIå›æ‡‰ï¼Œä½¿ç”¨åŸºæœ¬åˆ†æ',
                    vocabularyAnalysis: [],
                    writingStrategy: [
                        'åƒè€ƒåŸå¥çµæ§‹',
                        'æ›¿æ›é—œéµè©å½™',
                        'ä¿æŒèªæ³•æ­£ç¢ºæ€§'
                    ],
                    examples: [],
                    tips: `AIè§£æå¤±æ•—ï¼ˆ${error.message}ï¼‰ï¼Œå»ºè­°æ‰‹å‹•åˆ†æå¥å­çµæ§‹å¾Œé€²è¡Œä»¿å¯«ç·´ç¿’`
                };
            }
        }
        
        function validateHintObject(parsed) {
            const validated = {
                structure: parsed.structure || 'å¥å­çµæ§‹åˆ†æä¸­...',
                vocabularyAnalysis: Array.isArray(parsed.vocabularyAnalysis) ? parsed.vocabularyAnalysis : [],
                writingStrategy: Array.isArray(parsed.writingStrategy) ? parsed.writingStrategy : 
                                parsed.writingStrategies ? parsed.writingStrategies : 
                                ['åƒè€ƒåŸå¥çµæ§‹', 'æ›¿æ›é—œéµè©å½™'],
                examples: Array.isArray(parsed.examples) ? parsed.examples : [],
                tips: parsed.tips || parsed.tip || 'å»ºè­°ä¿æŒåŸå¥çµæ§‹ï¼Œæ›¿æ›é—œéµè©å½™ä¾†å‰µä½œæ–°å¥å­'
            };
            
            console.log('âœ… Validated hint object:', validated);
            return validated;
        }
        
        // Test cases
        const testCases = [
            {
                name: "Valid JSON with markdown code blocks",
                response: `\`\`\`json
{
  "structure": "å¥å­éµå¾ª [Na] + [å¤šå°‘] + [åè©] + [å‹•è©] + [åè©] çš„çµæ§‹",
  "vocabularyAnalysis": [
    {
      "word": "Na",
      "type": "ä»‹è©",
      "alternatives": ["Voor", "Tijdens"],
      "explanation": "è¡¨ç¤ºæ™‚é–“ä¹‹å¾Œ"
    }
  ],
  "writingStrategy": ["ä¿æŒæ™‚é–“çµæ§‹", "æ›¿æ›æ´»å‹•å…§å®¹"],
  "examples": ["Na het werk ga ik sporten", "Na de les gaan we eten"],
  "tips": "æ³¨æ„å‹•è©è®Šä½"
}
\`\`\``
            },
            {
                name: "JSON with extra text",
                response: `Here is the analysis:
{
  "structure": "åŸºæœ¬çµæ§‹ [ä¸»è©] + [å‹•è©] + [å½¢å®¹è©]",
  "vocabularyAnalysis": [],
  "writingStrategy": ["ç­–ç•¥1", "ç­–ç•¥2"],
  "examples": ["ä¾‹å¥1"],
  "tips": "æç¤ºå…§å®¹"
}
Additional notes...`
            },
            {
                name: "Already parsed object",
                response: {
                    structure: "Object structure",
                    vocabularyAnalysis: [{word: "test", type: "noun"}],
                    writingStrategy: ["strategy 1"],
                    examples: ["example 1"],
                    tips: "object tips"
                }
            },
            {
                name: "Malformed JSON",
                response: `{
  "structure": "å¥å­çµæ§‹",
  "vocabularyAnalysis": [
    // Missing closing bracket
  "writingStrategy": ["ç­–ç•¥"],
}`
            },
            {
                name: "Non-JSON response",
                response: "This is just plain text without any JSON structure"
            },
            {
                name: "Empty response",
                response: ""
            },
            {
                name: "Null response",
                response: null
            }
        ];
        
        function runTest(testCase) {
            const resultsDiv = document.getElementById('results');
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';
            
            try {
                const result = parseAIHint(testCase.response);
                
                const isValid = result.structure && 
                               Array.isArray(result.vocabularyAnalysis) &&
                               Array.isArray(result.writingStrategy) &&
                               Array.isArray(result.examples);
                
                testDiv.className += isValid ? ' success' : ' warning';
                testDiv.innerHTML = `
                    <h3>${testCase.name} - ${isValid ? 'âœ… Success' : 'âš ï¸ Fallback'}</h3>
                    <h4>Input:</h4>
                    <pre>${typeof testCase.response === 'string' ? 
                          testCase.response.substring(0, 200) + (testCase.response.length > 200 ? '...' : '') : 
                          JSON.stringify(testCase.response, null, 2)}</pre>
                    <h4>Output:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                testDiv.className += ' error';
                testDiv.innerHTML = `
                    <h3>${testCase.name} - âŒ Error</h3>
                    <h4>Input:</h4>
                    <pre>${typeof testCase.response === 'string' ? 
                          testCase.response : JSON.stringify(testCase.response)}</pre>
                    <h4>Error:</h4>
                    <pre>${error.toString()}</pre>
                `;
            }
            
            resultsDiv.appendChild(testDiv);
        }
        
        function runAllTests() {
            clearResults();
            testCases.forEach(testCase => {
                runTest(testCase);
            });
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // Auto-run tests on load
        window.addEventListener('load', runAllTests);
    </script>
</body>
</html>