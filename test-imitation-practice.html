<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仿寫練習測試 - Imitation Practice Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
            line-height: 1.6;
        }

        .header {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            color: #1976D2;
        }

        .header p {
            margin: 10px 0 0 0;
            color: #666;
        }

        .demo-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .demo-controls h2 {
            margin-top: 0;
        }

        .mock-sentences {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .sentence-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sentence-card:hover {
            background: #e3f2fd;
            border-color: #2196F3;
            transform: translateY(-2px);
        }

        .sentence-card.selected {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .sentence-text {
            font-weight: 500;
            margin-bottom: 8px;
        }

        .sentence-meta {
            font-size: 12px;
            color: #666;
        }

        .start-demo-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s;
        }

        .start-demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .start-demo-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .practice-container {
            display: none;
            min-height: 600px;
        }

        .feature-preview {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-item {
            padding: 20px;
            border-left: 4px solid #4CAF50;
            background: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }

        .feature-item h4 {
            margin-top: 0;
            color: #2e7d32;
        }

        .feature-item ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .feature-item li {
            margin-bottom: 5px;
        }

        .github-link {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #24292e;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            z-index: 1000;
        }

        .github-link:hover {
            background: #0366d6;
            text-decoration: none;
            color: white;
        }

        .error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f44336;
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            z-index: 1001;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- GitHub Link -->
    <a href="https://github.com/QQJasonChen/leverage_language" class="github-link" target="_blank">
        📚 GitHub Repository
    </a>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="header">
        <h1>✍️ 仿寫練習功能測試</h1>
        <p>Imitation Practice Feature Demo - 利用保存的句子進行智慧仿寫練習</p>
    </div>

    <div class="feature-preview">
        <h2>🎯 功能特色 (Key Features)</h2>
        <div class="feature-grid">
            <div class="feature-item">
                <h4>🔄 替換練習 (Substitution)</h4>
                <ul>
                    <li>智慧識別關鍵詞彙位置</li>
                    <li>提供同義詞替換建議</li>
                    <li>保持語法結構完整性</li>
                </ul>
            </div>
            <div class="feature-item">
                <h4>➕ 擴展練習 (Expansion)</h4>
                <ul>
                    <li>添加形容詞豐富描述</li>
                    <li>融入時間和地點表達</li>
                    <li>使用連接詞增加邏輯</li>
                </ul>
            </div>
            <div class="feature-item">
                <h4>🔀 轉換練習 (Transformation)</h4>
                <ul>
                    <li>時態變化練習</li>
                    <li>肯定句變否定句</li>
                    <li>陳述句變疑問句</li>
                </ul>
            </div>
            <div class="feature-item">
                <h4>🎭 情境練習 (Contextual)</h4>
                <ul>
                    <li>正式與非正式語境</li>
                    <li>商務與學術場合</li>
                    <li>口語與書面表達</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="demo-controls">
        <h2>📝 選擇練習句子 (Choose a sentence for practice)</h2>
        
        <div class="mock-sentences" id="mockSentences">
            <!-- Mock sentences will be loaded here -->
        </div>

        <button class="start-demo-btn" id="startDemo" disabled>
            🚀 開始練習 (Start Practice)
        </button>
    </div>

    <div class="practice-container" id="practiceContainer">
        <!-- Imitation practice UI will be loaded here -->
    </div>

    <!-- Scripts -->
    <script src="lib/imitation-practice-manager.js"></script>
    <script src="components/imitation-practice-ui.js"></script>
    
    <script>
        // Mock Chrome APIs for demo
        if (typeof chrome === 'undefined') {
            window.chrome = {
                runtime: {
                    sendMessage: async (message) => {
                        console.log('Mock chrome.runtime.sendMessage:', message);
                        
                        if (message.action === 'getLearningHistory') {
                            return {
                                history: mockSentences.map((sentence, index) => ({
                                    text: sentence.text,
                                    language: sentence.language || 'english',
                                    source: sentence.source || 'mock-source',
                                    timestamp: new Date(Date.now() - index * 24 * 60 * 60 * 1000).toISOString(),
                                    translation: sentence.translation
                                }))
                            };
                        }
                        
                        return { success: true };
                    }
                },
                storage: {
                    local: {
                        get: async (keys) => {
                            const data = {};
                            if (keys.includes && keys.includes('imitationPracticeHistory')) {
                                data.imitationPracticeHistory = JSON.parse(localStorage.getItem('imitationPracticeHistory') || '[]');
                            }
                            return data;
                        },
                        set: async (data) => {
                            for (const [key, value] of Object.entries(data)) {
                                localStorage.setItem(key, JSON.stringify(value));
                            }
                            return true;
                        }
                    }
                }
            };
        }

        // Mock sentences data
        const mockSentences = [
            {
                text: "I would like to know if you could help me with this project.",
                source: "youtube-business",
                language: "english",
                translation: "我想知道你是否可以幫助我完成這個項目。"
            },
            {
                text: "The more you practice, the better you become at speaking English.",
                source: "youtube-education", 
                language: "english",
                translation: "你練習得越多，你的英語口語就會變得越好。"
            },
            {
                text: "I used to be afraid of public speaking, but now I enjoy it.",
                source: "netflix-documentary",
                language: "english", 
                translation: "我過去害怕公眾演講，但現在我很享受它。"
            },
            {
                text: "If I had more time, I would learn another language.",
                source: "article-learning",
                language: "english",
                translation: "如果我有更多時間，我會學習另一種語言。"
            },
            {
                text: "Ik ga morgen met de trein naar Amsterdam voor een vergadering.",
                source: "dutch-news",
                language: "dutch",
                translation: "我明天要坐火車去阿姆斯特丹開會。"
            },
            {
                text: "このプロジェクトは来月までに完成しなければなりません。",
                source: "japanese-business",
                language: "japanese",
                translation: "這個項目必須在下個月之前完成。"
            }
        ];

        // Initialize demo
        let selectedSentenceIndex = -1;
        let practiceUI = null;

        function initializeMockSentences() {
            const container = document.getElementById('mockSentences');
            
            mockSentences.forEach((sentence, index) => {
                const card = document.createElement('div');
                card.className = 'sentence-card';
                card.dataset.index = index;
                
                card.innerHTML = `
                    <div class="sentence-text">${sentence.text}</div>
                    <div class="sentence-meta">
                        <span>🌐 ${sentence.language}</span> • 
                        <span>📺 ${sentence.source}</span>
                        ${sentence.translation ? `<br><em>${sentence.translation}</em>` : ''}
                    </div>
                `;
                
                card.addEventListener('click', () => selectSentence(index));
                container.appendChild(card);
            });
        }

        function selectSentence(index) {
            // Remove previous selection
            document.querySelectorAll('.sentence-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            document.querySelector(`[data-index="${index}"]`).classList.add('selected');
            selectedSentenceIndex = index;
            
            // Enable demo button
            document.getElementById('startDemo').disabled = false;
        }

        async function startDemo() {
            if (selectedSentenceIndex === -1) {
                showError('請先選擇一個句子');
                return;
            }

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // Hide demo controls and show practice container
                document.querySelector('.demo-controls').style.display = 'none';
                document.querySelector('.feature-preview').style.display = 'none';
                document.getElementById('practiceContainer').style.display = 'block';

                // Initialize practice UI
                const container = document.getElementById('practiceContainer');
                practiceUI = new ImitationPracticeUI(container);
                
                // Initialize with mock data
                await practiceUI.initialize();
                
                // Auto-select the chosen sentence
                setTimeout(() => {
                    const sentenceSelect = document.getElementById('sentenceSelect');
                    if (sentenceSelect) {
                        sentenceSelect.selectedIndex = selectedSentenceIndex + 1; // +1 for the default option
                        sentenceSelect.dispatchEvent(new Event('change'));
                    }
                }, 500);

            } catch (error) {
                console.error('Failed to start demo:', error);
                showError('啟動演示失敗，請重新整理頁面重試');
            } finally {
                // Hide loading
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'error-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Enhanced ImitationPracticeManager with mock functionality
        class MockImitationPracticeManager extends ImitationPracticeManager {
            constructor() {
                super();
                this.mockEvaluations = this.setupMockEvaluations();
            }

            setupMockEvaluations() {
                return {
                    high: {
                        score: Math.floor(Math.random() * 20) + 80, // 80-100
                        feedback: ['Grammar is excellent', 'Good vocabulary choice', 'Natural sentence flow'],
                        corrections: [],
                        strengths: ['Perfect grammar', 'Creative word choice', 'Natural expression'],
                        suggestions: ['Try using more advanced vocabulary', 'Consider adding more detail'],
                        encouragement: '🎉 Excellent work! Your sentence is very natural and well-constructed.'
                    },
                    medium: {
                        score: Math.floor(Math.random() * 20) + 60, // 60-79
                        feedback: ['Good attempt', 'Minor grammar issues', 'Could be more natural'],
                        corrections: ['Check verb tense', 'Article usage could be improved'],
                        strengths: ['Good understanding of pattern', 'Vocabulary is appropriate'],
                        suggestions: ['Practice more complex structures', 'Pay attention to prepositions'],
                        encouragement: '👍 Good job! Keep practicing to improve further.'
                    },
                    low: {
                        score: Math.floor(Math.random() * 20) + 40, // 40-59
                        feedback: ['Needs improvement', 'Several grammar errors', 'Vocabulary issues'],
                        corrections: ['Fix subject-verb agreement', 'Check word order', 'Use appropriate tenses'],
                        strengths: ['You tried to follow the pattern', 'Some vocabulary is correct'],
                        suggestions: ['Review basic grammar rules', 'Practice with simpler sentences first'],
                        encouragement: '💪 Keep trying! Everyone improves with practice.'
                    }
                };
            }

            evaluateImitation(userSentence, pattern, exerciseType) {
                // Simulate evaluation logic
                const wordCount = userSentence.split(' ').length;
                const hasBasicStructure = userSentence.includes(' ') && userSentence.length > 5;
                const hasVariation = userSentence.toLowerCase() !== pattern.original.toLowerCase();
                
                let category;
                if (hasBasicStructure && hasVariation && wordCount >= 6) {
                    category = 'high';
                } else if (hasBasicStructure && wordCount >= 4) {
                    category = 'medium';  
                } else {
                    category = 'low';
                }

                return this.mockEvaluations[category];
            }

            async savePracticeRecord(practice, userResponse, evaluation) {
                // Mock save to localStorage
                const record = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    practice: practice,
                    userResponse: userResponse,
                    evaluation: evaluation,
                    timeSpent: Math.floor(Math.random() * 60) + 30,
                    completed: true
                };

                const history = JSON.parse(localStorage.getItem('imitationPracticeHistory') || '[]');
                history.push(record);
                
                if (history.length > 100) {
                    history.splice(0, history.length - 100);
                }

                localStorage.setItem('imitationPracticeHistory', JSON.stringify(history));
                return record;
            }

            async getPracticeStats() {
                const history = JSON.parse(localStorage.getItem('imitationPracticeHistory') || '[]');
                
                if (history.length === 0) {
                    return {
                        totalPractices: 0,
                        averageScore: 0,
                        practicesByType: {},
                        recentProgress: [],
                        strengths: [],
                        weaknesses: []
                    };
                }

                const totalScore = history.reduce((sum, record) => sum + record.evaluation.score, 0);
                const practicesByType = {};
                
                history.forEach(record => {
                    const type = record.practice.type;
                    practicesByType[type] = (practicesByType[type] || 0) + 1;
                });

                const recentProgress = history
                    .slice(-7)
                    .map(record => ({
                        date: record.timestamp,
                        score: record.evaluation.score,
                        type: record.practice.type
                    }));

                return {
                    totalPractices: history.length,
                    averageScore: Math.round(totalScore / history.length),
                    practicesByType: practicesByType,
                    recentProgress: recentProgress,
                    strengths: ['Pattern recognition', 'Vocabulary usage'],
                    weaknesses: ['Grammar accuracy', 'Sentence fluency']
                };
            }
        }

        // Override the manager class for demo
        window.ImitationPracticeManager = MockImitationPracticeManager;

        // Event listeners
        document.getElementById('startDemo').addEventListener('click', startDemo);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeMockSentences();
            
            // Add some demo instructions
            const instructions = document.createElement('div');
            instructions.innerHTML = `
                <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0;">🎮 如何使用演示 (How to use this demo):</h3>
                    <ol>
                        <li>選擇一個你感興趣的句子 (Choose an interesting sentence)</li>
                        <li>點擊「開始練習」按鈕 (Click "Start Practice")</li>
                        <li>選擇練習類型 (Select practice type)</li>
                        <li>輸入你的仿寫句子 (Enter your imitation sentence)</li>
                        <li>獲得AI評估反饋 (Get AI evaluation feedback)</li>
                    </ol>
                    <p><strong>💡 提示：</strong>這是一個完全離線的演示，所有功能都使用模擬數據運行。</p>
                </div>
            `;
            
            document.querySelector('.demo-controls').insertBefore(instructions, document.getElementById('mockSentences'));
        });

        console.log('🎮 Imitation Practice Demo loaded successfully!');
        console.log('📚 Available mock sentences:', mockSentences.length);
    </script>
</body>
</html>